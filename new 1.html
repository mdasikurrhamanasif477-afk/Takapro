<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Earning Pro</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #1e293b;
            --accent: #f59e0b;
            --bg-dark: #0f172a;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #eab308;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Hind Siliguri', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-light); display: flex; height: 100vh; overflow: hidden; }
        
        /* --- Sidebar --- */
        .sidebar { width: 260px; background: var(--secondary); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; transition: 0.3s; }
        .brand { padding: 20px; font-size: 1.4rem; font-weight: bold; color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px; }
        .nav-links { list-style: none; padding: 20px 0; flex: 1; }
        .nav-item { padding: 12px 25px; cursor: pointer; color: var(--text-muted); transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 0.95rem; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); border-right: 3px solid var(--primary); }
        .nav-item i { width: 20px; text-align: center; }
        .logout-btn { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); cursor: pointer; color: var(--danger); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.1); }

        /* --- Main Content --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { height: 60px; background: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        .page-title { font-size: 1.2rem; font-weight: 600; }
        .content-area { flex: 1; overflow-y: auto; padding: 25px; }

        /* --- Stats Cards --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--secondary); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .bg-blue { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .bg-green { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .bg-orange { background: rgba(245, 158, 11, 0.1); color: var(--accent); }
        .bg-red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .stat-info h3 { font-size: 1.8rem; font-weight: bold; margin-bottom: 2px; }
        .stat-info p { font-size: 0.85rem; color: var(--text-muted); }

        /* --- Tables --- */
        .table-container { background: var(--secondary); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 20px; }
        .table-header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .search-box { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 8px; color: white; width: 250px; outline: none; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        th { background: rgba(0,0,0,0.2); font-weight: 600; color: var(--text-muted); }
        tr:hover { background: rgba(255,255,255,0.02); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .badge-pending { background: rgba(245, 158, 11, 0.15); color: var(--accent); }
        .badge-approved { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge-rejected { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-right: 5px; transition: 0.2s; }
        .btn-approve { background: var(--success); color: white; }
        .btn-reject { background: var(--danger); color: white; }
        .btn-edit { background: var(--primary); color: white; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- Login Screen --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--secondary); padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
        .login-box h2 { margin-bottom: 20px; color: var(--primary); }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-control { width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; outline: none; }
        .form-control:focus { border-color: var(--primary); }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .admin-hint { margin-top: 15px; font-size: 0.8rem; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--secondary); padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .close-modal { cursor: pointer; font-size: 1.2rem; color: var(--text-muted); }
        .user-details-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.95rem; }
        .user-details-label { color: var(--text-muted); }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast { position: fixed; top: 20px; right: 20px; background: var(--secondary); color: white; padding: 15px 25px; border-radius: 8px; border-left: 4px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.3); transform: translateX(150%); transition: transform 0.3s ease; z-index: 3000; }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Action Successful</div>

    <!-- Login Screen -->
    <section id="login-screen">
        <div class="login-box">
            <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
            <form onsubmit="handleAdminLogin(event)">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="admin-phone" class="form-control" placeholder="Enter Admin Phone" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="admin-pass" class="form-control" placeholder="Enter Password" required>
                </div>
                <button type="submit" class="btn-login">Login Panel</button>
            </form>
            <div class="admin-hint">
                <strong>Demo Credentials:</strong><br>
                Phone: 01700000000<br>
                Pass: admin123
            </div>
        </div>
    </section>

    <!-- Main App (Hidden initially) -->
    <div id="admin-panel" class="hidden" style="width: 100%; height: 100%; display: flex;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fas fa-rocket"></i> Admin Panel
            </div>
            <ul class="nav-links">
                <li class="nav-item active" onclick="showSection('dashboard', this)">
                    <i class="fas fa-chart-line"></i> ড্যাশবোর্ড
                </li>
                <li class="nav-item" onclick="showSection('withdrawals', this)">
                    <i class="fas fa-money-bill-wave"></i> উত্তোলন রিকোয়েস্ট
                </li>
                <li class="nav-item" onclick="showSection('deposits', this)">
                    <i class="fas fa-wallet"></i> ডিপোজিট রিকোয়েস্ট
                </li>
                <li class="nav-item" onclick="showSection('users', this)">
                    <i class="fas fa-users"></i> ইউজার ম্যানেজমেন্ট
                </li>
            </ul>
            <div class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> লগআউট
            </div>
        </aside>

        <!-- Content -->
        <main class="main-content">
            <header class="header">
                <div class="page-title" id="page-title">ড্যাশবোর্ড</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.9rem; color: var(--text-muted);">Admin</span>
                    <div style="width: 35px; height: 35px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user"></i></div>
                </div>
            </header>

            <div class="content-area">
                
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue"><i class="fas fa-users"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-total-users">0</h3>
                                <p>মোট ইউজার</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-orange"><i class="fas fa-clock"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-pending-withdraw">0</h3>
                                <p>পেন্ডিং উত্তোলন</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green"><i class="fas fa-coins"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-total-paid">৳ 0</h3>
                                <p>মোট পেমেন্ট</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-red"><i class="fas fa-wallet"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-pending-deposit">0</h3>
                                <p>পেন্ডিং ডিপোজিট</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Table (Combined) -->
                    <div class="table-container">
                        <div class="table-header">
                            <h4>সাম্প্রতিক কার্যকলাপ</h4>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="recent-activity-table">
                                <thead>
                                    <tr>
                                        <th>ইউজার</th>
                                        <th>ধরন</th>
                                        <th>পরিমাণ</th>
                                        <th>মেথড</th>
                                        <th>তারিখ</th>
                                        <th>স্ট্যাটাস</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Withdrawals Section -->
                <div id="withdrawals" class="section">
                    <div class="table-container">
                        <div class="table-header">
                            <h4>উত্তোলন রিকোয়েস্ট তালিকা</h4>
                            <input type="text" id="search-withdraw" class="search-box" placeholder="নাম্বার দিয়ে সার্চ করুন..." onkeyup="filterTable('withdraw-table', this.value)">
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="withdraw-table">
                                <thead>
                                    <tr>
                                        <th>তথ্য (নাম/ফোন)</th>
                                        <th>মেথড</th>
                                        <th>একাউন্ট</th>
                                        <th>পরিমাণ</th>
                                        <th>তারিখ</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="withdraw-tbody">
                                    <tr><td colspan="6" style="text-align:center;">লোড হচ্ছে...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Deposits Section -->
                <div id="deposits" class="section">
                    <div class="table-container">
                        <div class="table-header">
                            <h4>ডিপোজিট রিকোয়েস্ট তালিকা</h4>
                            <input type="text" id="search-deposit" class="search-box" placeholder="নাম্বার দিয়ে সার্চ করুন..." onkeyup="filterTable('deposit-table', this.value)">
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="deposit-table">
                                <thead>
                                    <tr>
                                        <th>তথ্য (নাম/ফোন)</th>
                                        <th>মেথড</th>
                                        <th>সেন্ডার</th>
                                        <th>পরিমাণ</th>
                                        <th>TrxID</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="deposit-tbody">
                                    <tr><td colspan="6" style="text-align:center;">লোড হচ্ছে...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Management Section -->
                <div id="users" class="section">
                    <div class="table-container">
                        <div class="table-header">
                            <h4>সকল ইউজার</h4>
                            <input type="text" id="search-users" class="search-box" placeholder="নাম বা ফোন দিয়ে সার্চ..." onkeyup="filterTable('users-table', this.value)">
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="users-table">
                                <thead>
                                    <tr>
                                        <th>নাম</th>
                                        <th>ফোন</th>
                                        <th>ব্যালেন্স</th>
                                        <th>মেম্বারশিপ</th>
                                        <th>যোগদান</th>
                                        <th>অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody">
                                    <tr><td colspan="6" style="text-align:center;">লোড হচ্ছে...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Edit Balance Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>ব্যালেন্স পরিবর্তন করুন</h3>
                <span class="close-modal" onclick="closeModal('edit-modal')">&times;</span>
            </div>
            <div class="user-details-row">
                <span class="user-details-label">ইউজার:</span>
                <span id="modal-user-name" style="font-weight: bold;">-</span>
            </div>
            <div class="user-details-row">
                <span class="user-details-label">বর্তমান ব্যালেন্স:</span>
                <span id="modal-current-balance">৳ 0.00</span>
            </div>
            
            <div class="form-group">
                <label>অপারেশন সিলেক্ট করুন</label>
                <select id="balance-action" class="form-control">
                    <option value="add">ব্যালেন্স যোগ করুন (+)</option>
                    <option value="deduct">ব্যালেন্স কমান (-)</option>
                    <option value="set">নতুন ব্যালেন্স সেট করুন</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>পরিমাণ (টাকা)</label>
                <input type="number" id="balance-amount" class="form-control" placeholder="0.00">
            </div>

            <button class="btn-login" onclick="submitBalanceChange()">আপডেট করুন</button>
        </div>
    </div>

    <script>
        // --- Firebase Config (Same as User App) ---
        if (!firebase.apps.length) {
            firebase.initializeApp({
                apiKey: "AIzaSyDEFmlb1z_XywhJs_HFhFyECu0WNIQ5NyE",
                authDomain: "eanrtaka.firebaseapp.com",
                databaseURL: "https://eanrtaka-default-rtdb.firebaseio.com",
                projectId: "eanrtaka",
                storageBucket: "eanrtaka.firebasestorage.app",
                messagingSenderId: "49744195787",
                appId: "1:49744195787:web:3439970d0acddbce84eb4e",
                measurementId: "G-HZ3NECKG9Y"
            });
        }
        const db = firebase.database();

        // --- State ---
        let allUsers = [];
        let currentEditPhone = null;
        let pendingWithdrawals = [];
        let pendingDeposits = [];

        // --- Auth Logic ---
        function handleAdminLogin(e) {
            e.preventDefault();
            const phone = document.getElementById('admin-phone').value.trim();
            const pass = document.getElementById('admin-pass').value.trim();

            // HARDCODED ADMIN CREDENTIALS FOR DEMO
            // In production, check a specific 'admins' node in Firebase
            if (phone === '01700000000' && pass === 'admin123') {
                localStorage.setItem('admin_logged_in', 'true');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                initAdminPanel();
            } else {
                showToast('ভুল ফোন নাম্বার বা পাসওয়ার্ড!', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('admin_logged_in');
            location.reload();
        }

        function checkAuth() {
            if (localStorage.getItem('admin_logged_in') === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                initAdminPanel();
            }
        }

        // --- Main Logic ---
        function initAdminPanel() {
            fetchAllUsers();
        }

        function fetchAllUsers() {
            const usersRef = db.ref('users');
            usersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                allUsers = [];
                
                pendingWithdrawals = [];
                pendingDeposits = [];
                let totalPaid = 0;

                if (data) {
                    Object.keys(data).forEach(key => {
                        const user = data[key];
                        user.phone = key; // Ensure phone key is available
                        allUsers.push(user);

                        // Collect Pending Withdrawals
                        if (user.withdrawals) {
                            user.withdrawals.forEach(w => {
                                if (w.status === 'Pending') {
                                    pendingWithdrawals.push({ ...w, userPhone: user.phone, userName: user.name });
                                } else if (w.status === 'Approved') {
                                    totalPaid += w.amount;
                                }
                            });
                        }

                        // Collect Pending Deposits
                        if (user.deposits) {
                            user.deposits.forEach(d => {
                                if (d.status === 'Pending') {
                                    pendingDeposits.push({ ...d, userPhone: user.phone, userName: user.name });
                                }
                            });
                        }
                    });
                }

                // Update Stats
                document.getElementById('stat-total-users').textContent = allUsers.length;
                document.getElementById('stat-pending-withdraw').textContent = pendingWithdrawals.length;
                document.getElementById('stat-total-paid').textContent = '৳ ' + totalPaid.toFixed(2);
                document.getElementById('stat-pending-deposit').textContent = pendingDeposits.length;

                // Render Tables
                renderUserTable(allUsers);
                renderWithdrawTable(pendingWithdrawals);
                renderDepositTable(pendingDeposits);
                renderRecentActivity();
            });
        }

        // --- Render Functions ---

        function renderUserTable(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">কোনো ইউজার পাওয়া যায়নি</td></tr>';
                return;
            }

            users.forEach(user => {
                const memStatus = user.membership ? (user.membership.status === 'active' ? 'Active' : 'Expired') : 'None';
                const joinDate = user.joined ? new Date(user.joined).toLocaleDateString() : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td style="color: var(--success); font-weight: bold;">৳ ${user.balance.toFixed(2)}</td>
                    <td><span class="badge ${memStatus === 'Active' ? 'badge-approved' : 'badge-pending'}">${memStatus}</span></td>
                    <td>${joinDate}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openEditModal('${user.phone}')"><i class="fas fa-edit"></i> Edit Balance</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderWithdrawTable(withdrawals) {
            const tbody = document.getElementById('withdraw-tbody');
            tbody.innerHTML = '';

            if (withdrawals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">কোনো পেন্ডিং রিকোয়েস্ট নেই</td></tr>';
                return;
            }

            withdrawals.forEach(w => {
                const dateStr = new Date(w.date).toLocaleDateString();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight: bold;">${w.userName}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${w.userPhone}</div>
                    </td>
                    <td style="text-transform: capitalize;">${w.method}</td>
                    <td>${w.account}</td>
                    <td style="color: var(--accent); font-weight: bold;">৳ ${w.amount.toFixed(2)}</td>
                    <td>${dateStr}</td>
                    <td>
                        <button class="action-btn btn-approve" onclick="processWithdraw('${w.userPhone}', '${w.id}', 'approve')">Approve</button>
                        <button class="action-btn btn-reject" onclick="processWithdraw('${w.userPhone}', '${w.id}', 'reject')">Reject</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDepositTable(deposits) {
            const tbody = document.getElementById('deposit-tbody');
            tbody.innerHTML = '';

            if (deposits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">কোনো পেন্ডিং রিকোয়েস্ট নেই</td></tr>';
                return;
            }

            deposits.forEach(d => {
                const dateStr = new Date(d.date).toLocaleDateString();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight: bold;">${d.userName}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${d.userPhone}</div>
                    </td>
                    <td style="text-transform: capitalize;">${d.method}</td>
                    <td>${d.sender}</td>
                    <td style="color: var(--success); font-weight: bold;">৳ ${d.amount.toFixed(2)}</td>
                    <td style="font-family: monospace;">${d.trx}</td>
                    <td>
                        <button class="action-btn btn-approve" onclick="processDeposit('${d.userPhone}', '${d.id}', 'approve')">Approve</button>
                        <button class="action-btn btn-reject" onclick="processDeposit('${d.userPhone}', '${d.id}', 'reject')">Reject</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderRecentActivity() {
            const tbody = document.querySelector('#recent-activity-table tbody');
            tbody.innerHTML = '';
            
            // Combine last 5 withdrawals and deposits for activity feed
            let activities = [];
            
            allUsers.forEach(u => {
                if(u.withdrawals) u.withdrawals.forEach(w => activities.push({...w, userName: u.name, userPhone: u.phone, type: 'Withdraw'}));
                if(u.deposits) u.deposits.forEach(d => activities.push({...d, userName: u.name, userPhone: u.phone, type: 'Deposit'}));
            });

            // Sort by date (newest first) and take top 5
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recent = activities.slice(0, 5);

            if(recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">কোনো তথ্য নেই</td></tr>';
                return;
            }

            recent.forEach(act => {
                let badgeClass = act.status === 'Approved' ? 'badge-approved' : (act.status === 'Rejected' ? 'badge-rejected' : 'badge-pending');
                let method = act.method || '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${act.userName}</td>
                    <td>${act.type}</td>
                    <td style="font-weight:bold;">৳ ${act.amount}</td>
                    <td>${method}</td>
                    <td>${new Date(act.date).toLocaleDateString()}</td>
                    <td><span class="badge ${badgeClass}">${act.status}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Action Logic ---

        // 1. Process Withdrawal
        async function processWithdraw(phone, withdrawId, action) {
            if (!confirm(`Are you sure you want to ${action} this withdrawal?`)) return;

            const userRef = db.ref('users/' + phone);
            const snapshot = await userRef.once('value');
            const user = snapshot.val();

            if (!user || !user.withdrawals) return;

            // Find and update the specific withdrawal
            const updatedWithdrawals = user.withdrawals.map(w => {
                if (w.id == withdrawId) {
                    return { ...w, status: action === 'approve' ? 'Approved' : 'Rejected' };
                }
                return w;
            });

            // Logic: If Rejected, Refund Balance
            let newBalance = user.balance;
            if (action === 'reject') {
                const withdrawReq = user.withdrawals.find(w => w.id == withdrawId);
                if (withdrawReq) {
                    newBalance += withdrawReq.amount;
                }
            }

            // Update Firebase
            await userRef.update({
                balance: newBalance,
                withdrawals: updatedWithdrawals
            });

            showToast(`Withdrawal ${action}d successfully!`);
            // Data listener will auto-refresh table
        }

        // 2. Process Deposit
        async function processDeposit(phone, depositId, action) {
            if (!confirm(`Are you sure you want to ${action} this deposit?`)) return;

            const userRef = db.ref('users/' + phone);
            const snapshot = await userRef.once('value');
            const user = snapshot.val();

            if (!user || !user.deposits) return;

            // Find deposit
            const depositReq = user.deposits.find(d => d.id == depositId);
            
            let newBalance = user.balance;

            if (action === 'approve') {
                if (depositReq) {
                    newBalance += depositReq.amount;
                }
            }

            // Update status
            const updatedDeposits = user.deposits.map(d => {
                if (d.id == depositId) {
                    return { ...d, status: action === 'approve' ? 'Approved' : 'Rejected' };
                }
                return d;
            });

            await userRef.update({
                balance: newBalance,
                deposits: updatedDeposits
            });

            showToast(`Deposit ${action}d successfully!`);
        }

        // 3. Edit User Balance
        function openEditModal(phone) {
            const user = allUsers.find(u => u.phone === phone);
            if (!user) return;

            currentEditPhone = phone;
            document.getElementById('modal-user-name').textContent = user.name + ' (' + user.phone + ')';
            document.getElementById('modal-current-balance').textContent = '৳ ' + user.balance.toFixed(2);
            document.getElementById('balance-amount').value = '';
            
            document.getElementById('edit-modal').style.display = 'flex';
        }

        async function submitBalanceChange() {
            const action = document.getElementById('balance-action').value;
            const amount = parseFloat(document.getElementById('balance-amount').value);

            if (isNaN(amount) || amount < 0) {
                showToast('সঠিক টাকার পরিমাণ দিন।');
                return;
            }

            const userRef = db.ref('users/' + currentEditPhone);
            const snapshot = await userRef.once('value');
            const user = snapshot.val();
            let newBalance = user.balance;

            if (action === 'add') newBalance += amount;
            else if (action === 'deduct') newBalance -= amount;
            else newBalance = amount;

            await userRef.update({ balance: newBalance });
            
            showToast('ব্যালেন্স আপডেট সফল হয়েছে!');
            closeModal('edit-modal');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- UI Utilities ---

        function showSection(sectionId, navItem) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById(sectionId).classList.add('active');
            
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navItem.classList.add('active');

            // Update Title
            const titles = {
                'dashboard': 'ড্যাশবোর্ড',
                'withdrawals': 'উত্তোলন রিকোয়েস্ট',
                'deposits': 'ডিপোজিট রিকোয়েস্ট',
                'users': 'ইউজার ম্যানেজমেন্ট'
            };
            document.getElementById('page-title').textContent = titles[sectionId];
        }

        function filterTable(tableId, query) {
            const table = document.getElementById(tableId);
            const trs = table.getElementsByTagName('tr');
            const filter = query.toLowerCase();

            for (let i = 1; i < trs.length; i++) { // Skip header
                let text = trs[i].textContent || trs[i].innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    trs[i].style.display = "";
                } else {
                    trs[i].style.display = "none";
                }
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Init
        window.onload = checkAuth;

    </script>
</body>
</html>